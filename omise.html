import React, { useState } from 'react';
import { Search, MapPin, Star, Utensils, ChevronRight, AlertCircle, ArrowLeft, RotateCw } from 'lucide-react';

// Google Maps API 로드 헬퍼 (핵심 로직만 남김)
const loadGoogleMapsScript = (apiKey) => {
  return new Promise((resolve, reject) => {
    // 1. 이미 로드된 경우 바로 성공 처리
    if (window.google && window.google.maps && typeof window.google.maps.importLibrary === 'function') {
      resolve();
      return;
    }

    // 2. 구버전 API 충돌 방지 및 정리
    if (window.google && window.google.maps && typeof window.google.maps.importLibrary !== 'function') {
      document.querySelectorAll('script[src*="maps.googleapis.com"]').forEach(s => s.remove());
      try { delete window.google; } catch (e) { window.google = undefined; }
    }
    
    // 3. 중복 로딩 방지
    const existingScript = document.querySelector('script[src*="maps.googleapis.com/maps/api/js"]');
    if (existingScript) {
      existingScript.addEventListener('load', () => waitForGoogleMaps(resolve));
      existingScript.addEventListener('error', (err) => reject(err));
      return;
    }

    // 4. 스크립트 새로 로드
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&loading=async&libraries=places&v=weekly`;
    script.async = true;
    script.defer = true;
    script.onload = () => waitForGoogleMaps(resolve);
    script.onerror = (err) => reject(err);
    
    document.head.appendChild(script);
  });
};

// API 객체가 준비될 때까지 안전하게 대기
const waitForGoogleMaps = (resolve) => {
  let checks = 0;
  const timer = setInterval(() => {
    checks++;
    if (window.google?.maps?.importLibrary) {
      clearInterval(timer);
      resolve();
    } else if (checks > 20) {
      clearInterval(timer);
      resolve();
    }
  }, 100);
};

const App = () => {
  const GOOGLE_MAPS_API_KEY = "AIzaSyCRic1gBK1wiSS7-mKSFBwL70TInVP2Ldk";

  const [city, setCity] = useState('');
  const [food, setFood] = useState('');
  const [results, setResults] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [step, setStep] = useState('input');
  
  const searchRestaurants = async () => {
    if (!city.trim() || !food.trim()) {
      setError('도시와 음식 종류를 입력해주세요.');
      return;
    }

    setLoading(true);
    setError('');
    setStep('loading');
    setResults([]);

    const timeoutId = setTimeout(() => {
      setLoading(false);
      setError('응답이 지연되고 있어요. 새로고침 후 다시 시도해 주세요.');
      setStep('input');
    }, 8000);

    try {
      await loadGoogleMapsScript(GOOGLE_MAPS_API_KEY);
      
      if (!window.google?.maps?.importLibrary) {
        throw new Error("LEGACY_MAPS_DETECTED");
      }

      const { Place } = await window.google.maps.importLibrary("places");
      
      const request = {
        textQuery: `일본 ${city} ${food}`,
        fields: ['displayName', 'formattedAddress', 'rating', 'userRatingCount', 'id', 'location'],
      };

      const { places } = await Place.searchByText(request);

      clearTimeout(timeoutId);

      if (places && places.length > 0) {
        const filtered = places
          .filter(place => 
            place.rating && 
            place.userRatingCount && 
            place.rating >= 4.1 && 
            place.userRatingCount >= 300
          )
          // 한국 식당 제외 필터
          .filter(place => {
             const addr = place.formattedAddress || "";
             return !addr.includes("대한민국") && !addr.includes("Korea") && !addr.includes("South Korea") && !addr.includes("서울");
          })
          .map(place => ({
            id: place.id, 
            placeId: place.id,
            name: place.displayName, 
            koreanName: place.displayName,
            rating: place.rating,
            reviewCount: place.userRatingCount,
            description: place.formattedAddress, 
            address: place.formattedAddress,
          }))
          .sort((a, b) => b.rating - a.rating);

        if (filtered.length === 0) {
          setError('조건(4.1점+, 리뷰 300개+)에 맞는 맛집이 없어요.');
          setStep('input');
        } else {
          setResults(filtered);
          setStep('results');
        }
      } else {
        setError('검색 결과를 가져오지 못했어요.');
        setStep('input');
      }
      setLoading(false);

    } catch (err) {
      clearTimeout(timeoutId);
      console.error("Search Error:", err);

      if (err.message === "LEGACY_MAPS_DETECTED" || (err.message && err.message.includes("importLibrary"))) {
        setError('브라우저 업데이트를 위해 "새로고침"이 꼭 필요해요!');
      } else {
        setError('검색 중 오류가 발생했어요.');
      }
      
      setStep('input');
      setLoading(false);
    }
  };

  const handleReset = () => {
    setCity('');
    setFood('');
    setStep('input');
    setResults([]);
  };

  const openGoogleMaps = (name, city) => {
    const query = encodeURIComponent(`${city} ${name}`);
    window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, '_blank');
  };

  // --- UI Components ---
  const GlassCard = ({ children, className = "", onClick }) => (
    <div onClick={onClick} className={`bg-white/80 backdrop-blur-xl border border-gray-100 shadow-lg shadow-gray-200/50 rounded-[28px] p-6 transition-all duration-300 hover:bg-white hover:scale-[1.02] active:scale-[0.98] cursor-pointer ${className}`}>
      {children}
    </div>
  );

  const RestaurantItem = ({ item }) => {
    return (
      <GlassCard onClick={() => openGoogleMaps(item.name, city)} className="group mb-5 relative overflow-hidden">
        <div className="flex justify-between items-start mb-3 relative z-10 gap-3">
          <div className="flex-1 min-w-0">
            <h3 className="text-[21px] font-bold text-gray-900 leading-snug tracking-tight break-keep mb-1.5">
              {item.koreanName}
            </h3>
            {/* 주소 텍스트 색상 변경: text-gray-500 -> text-gray-600 */}
            <p className="text-[15px] text-gray-600 font-medium tracking-wide break-words leading-relaxed">
                {item.address}
            </p>
          </div>
          <div className="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center shadow-lg shadow-blue-500/30 group-hover:scale-110 transition-transform shrink-0 mt-1">
             <ChevronRight className="w-5 h-5 text-white" />
          </div>
        </div>

        <div className="flex items-center gap-2 pt-2 border-t border-gray-100/50 mt-2">
          <div className="flex items-center gap-1 bg-gray-900/5 px-3 py-1.5 rounded-full backdrop-blur-sm">
            <Star className="w-4 h-4 text-orange-500 fill-orange-500" />
            <span className="text-[15px] font-bold text-gray-800">{item.rating.toFixed(1)}</span>
          </div>
          {/* 리뷰 수 텍스트 색상 변경: text-gray-400 -> text-gray-500 */}
          <span className="text-sm font-medium text-gray-500 px-1">리뷰 {item.reviewCount.toLocaleString()}+</span>
          
          <div className="ml-auto flex items-center text-blue-500 text-xs font-bold gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
            <MapPin className="w-3.5 h-3.5" />
            <span>지도보기</span>
          </div>
        </div>
      </GlassCard>
    );
  };

  return (
    <div className="min-h-screen relative overflow-hidden text-gray-800 selection:bg-blue-500/20">
      <style>{`
        @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css");
        * { font-family: "Pretendard Variable", Pretendard, sans-serif !important; }
        .mesh-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%); background-size: 200% 200%; z-index: -2; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
      `}</style>

      {/* Background: 더 밝게 변경 (bg-white) */}
      <div className="fixed inset-0 bg-white -z-20"></div>
      <div className="mesh-bg absolute inset-0 -z-10 opacity-60"></div>
      
      {/* Mesh Orbs */}
      <div className="fixed top-[-10%] left-[-10%] w-[50vw] h-[50vw] bg-[#C4D7FF] blur-[100px] opacity-40 rounded-full animate-[move_20s_infinite_alternate] -z-10" style={{animation: 'move 20s infinite alternate'}}></div>
      <div className="fixed bottom-[10%] right-[-10%] w-[60vw] h-[60vw] bg-[#E8F1FF] blur-[120px] opacity-40 rounded-full animate-[move2_25s_infinite_alternate] -z-10" style={{animation: 'move2 25s infinite alternate'}}></div>

      {/* Keyframes (JSX 내장) */}
      <style>{`
        @keyframes move { from { transform: translate(0,0); } to { transform: translate(20px, 50px); } }
        @keyframes move2 { from { transform: translate(0,0); } to { transform: translate(-30px, -40px); } }
      `}</style>

      {/* Header */}
      <header className="fixed top-6 left-0 right-0 z-50 flex justify-center px-6">
        <div className="bg-white/80 backdrop-blur-2xl border border-white/50 shadow-xl shadow-gray-200/40 rounded-full px-6 py-3 flex items-center justify-center min-w-[120px]">
          <span className="font-bold text-gray-900 flex items-center gap-2">
            <Utensils className="w-4 h-4 text-blue-500" />
            일본여행정보공유
          </span>
        </div>
      </header>

      {/* Main Content */}
      <main className="max-w-md mx-auto pt-32 px-6 pb-32 min-h-screen flex flex-col">
        {step === 'input' && (
          <div className="flex flex-col h-full animate-[slideUp_0.5s_cubic-bezier(0.16,1,0.3,1)]">
            <div className="mb-10">
              <h1 className="text-[40px] font-extrabold text-gray-900 leading-[1.1] tracking-tight mb-4">일본,<br />어디서 드시나요?</h1>
              {/* 설명 텍스트 색상 변경: text-gray-500 -> text-gray-700 */}
              <p className="text-gray-700 text-lg font-medium leading-relaxed">실패 없는 미식 여행을 위해<br/><span className="text-blue-600 font-bold">별점 4.1+</span> 인증된 곳만 찾아드릴게요.</p>
            </div>
            <div className="space-y-6">
              <div className="group relative">
                {/* 라벨 색상 변경: text-gray-400 -> text-gray-500 */}
                <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 ml-4">Location</label>
                <div className="relative">
                  {/* 아이콘 색상 변경: text-gray-400 -> text-gray-500 */}
                  <div className="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none"><MapPin className="h-6 w-6 text-gray-500 group-focus-within:text-blue-500 transition-colors" /></div>
                  {/* Placeholder 색상 변경: placeholder-gray-300 -> placeholder-gray-400 */}
                  <input type="text" value={city} onChange={(e) => setCity(e.target.value)} className="block w-full pl-14 pr-6 py-5 bg-white/70 backdrop-blur-xl border border-white/50 rounded-[24px] text-xl font-bold text-gray-900 placeholder-gray-400 focus:ring-0 focus:outline-none focus:bg-white shadow-lg shadow-gray-200/50 transition-all duration-300" placeholder="도시 입력 (예: 오사카)" onKeyDown={(e) => e.key === 'Enter' && document.getElementById('food-input').focus()} />
                </div>
              </div>
              <div className="group relative">
                {/* 라벨 색상 변경 */}
                <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 ml-4">Cuisine</label>
                <div className="relative">
                  {/* 아이콘 색상 변경 */}
                  <div className="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none"><Utensils className="h-6 w-6 text-gray-500 group-focus-within:text-blue-500 transition-colors" /></div>
                  {/* Placeholder 색상 변경 */}
                  <input id="food-input" type="text" value={food} onChange={(e) => setFood(e.target.value)} className="block w-full pl-14 pr-6 py-5 bg-white/70 backdrop-blur-xl border border-white/50 rounded-[24px] text-xl font-bold text-gray-900 placeholder-gray-400 focus:ring-0 focus:outline-none focus:bg-white shadow-lg shadow-gray-200/50 transition-all duration-300" placeholder="메뉴 입력 (예: 야키니쿠)" onKeyDown={(e) => e.key === 'Enter' && searchRestaurants()} />
                </div>
              </div>
            </div>
            
            {error && (
              <div className="mt-6 flex flex-col items-center justify-center p-6 bg-red-50/80 border border-red-200 backdrop-blur-md text-red-600 rounded-3xl animate-[shake_0.5s_ease-in-out]">
                <div className="flex items-center gap-2 mb-3">
                    <AlertCircle className="w-6 h-6 shrink-0" />
                    <span className="text-base font-bold">{error}</span>
                </div>
                <button 
                    onClick={() => window.location.reload()}
                    className="flex items-center gap-2 px-6 py-3 bg-red-500 text-white rounded-2xl font-bold text-base shadow-lg shadow-red-500/30 hover:bg-red-600 hover:scale-105 transition-all w-full justify-center"
                >
                    <RotateCw className="w-5 h-5" /> 해결하기 (새로고침)
                </button>
                <p className="text-xs text-red-400 mt-2 font-medium">문제가 지속되면 버튼을 눌러주세요</p>
              </div>
            )}

            <div className="mt-10">
              <button onClick={searchRestaurants} className="w-full bg-black text-white text-[19px] font-bold py-5 rounded-[24px] shadow-2xl shadow-gray-900/30 hover:scale-[1.02] active:scale-[0.98] transition-all duration-300 flex items-center justify-center gap-3">
                <span>맛집 검색하기</span><ArrowLeft className="w-5 h-5 rotate-180" />
              </button>
            </div>
          </div>
        )}
        {step === 'loading' && (
          <div className="flex flex-col items-center justify-center min-h-[60vh] animate-[fadeIn_0.5s_ease-in]">
            <div className="relative w-24 h-24 mb-8">
              <div className="absolute inset-0 border-4 border-gray-100 rounded-full"></div>
              <div className="absolute inset-0 border-4 border-t-blue-500 border-r-transparent border-b-transparent border-l-transparent rounded-full animate-spin"></div>
              <div className="absolute inset-0 flex items-center justify-center"><Search className="w-8 h-8 text-blue-500 animate-pulse" /></div>
            </div>
            <h3 className="text-2xl font-bold text-gray-900 mb-2">Searching...</h3>
            {/* 로딩 텍스트 색상 변경: text-gray-500 -> text-gray-600 */}
            <p className="text-gray-600 font-medium text-center leading-relaxed">{city}의 {food} 맛집 중<br/>평점 4.1 이상, 리뷰 300개 이상 맛집을 찾고 있어요.</p>
          </div>
        )}
        {step === 'results' && (
          <div className="animate-[slideUp_0.6s_cubic-bezier(0.16,1,0.3,1)]">
            <div className="flex items-center justify-between mb-8 px-1">
              <div>
                <h2 className="text-[28px] font-extrabold text-gray-900 leading-none mb-1">Results</h2>
                {/* 결과 서브텍스트 색상 변경: text-gray-500 -> text-gray-600 */}
                <p className="text-sm font-medium text-gray-600">{food} in {city}의 {food} 검색 결과  </p>
              </div>
              <button onClick={handleReset} className="w-10 h-10 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200 transition-colors"><ArrowLeft className="w-5 h-5" /></button>
            </div>
            <div className="pb-10">
              {results.map((item, index) => <div key={index} className="animate-[fadeIn_0.5s_ease-out]" style={{ animationDelay: `${index * 0.1}s`, animationFillMode: 'both' }}><RestaurantItem item={item} /></div>)}
            </div>
          </div>
        )}
      </main>
    </div>
  );
};

export default App;
